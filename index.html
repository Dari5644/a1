<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Smart Bot â€“ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #0a1014;
      color: #e9edef;
      height: 100vh;
      overflow: hidden;
    }
    .app {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 30%;
      max-width: 360px;
      background-color: #111b21;
      border-left: 1px solid #202c33;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 12px 16px;
      background-color: #202c33;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #202c33;
    }
    .bot-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .bot-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      background-color: #202c33;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
    }
    .bot-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .bot-name {
      font-weight: 600;
      font-size: 14px;
    }
    .owner-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #128c7e;
      background: transparent;
      color: #e9edef;
      cursor: pointer;
    }
    .contacts-list {
      flex: 1;
      overflow-y: auto;
    }
    .contact-item {
      padding: 10px 12px;
      border-bottom: 1px solid #202c33;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .contact-item:hover {
      background-color: #202c33;
    }
    .contact-item.active {
      background-color: #202c33;
    }
    .contact-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .contact-name {
      font-size: 14px;
      font-weight: 500;
    }
    .contact-last {
      font-size: 12px;
      color: #8696a0;
      max-height: 32px;
      overflow: hidden;
    }
    .badge-paused {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #f15c5c;
      color: #f15c5c;
    }

    .chat {
      flex: 1;
      background-color: #0a1014;
      display: flex;
      flex-direction: column;
    }
    .chat-header {
      padding: 10px 16px;
      background-color: #202c33;
      border-bottom: 1px solid #202c33;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 52px;
    }
    .chat-title {
      font-size: 14px;
      font-weight: 500;
    }
    .chat-sub {
      font-size: 12px;
      color: #8696a0;
    }
    .chat-header-actions {
      display: flex;
      gap: 8px;
    }
    .chat-header-actions button {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #202c33;
      background: transparent;
      color: #e9edef;
      cursor: pointer;
    }
    .chat-header-actions button:hover {
      background-color: #202c33;
    }
    .chat-messages {
      flex: 1;
      padding: 16px;
      background-image: radial-gradient(circle at 0 0, #202c33 0, transparent 30%),
                        radial-gradient(circle at 100% 100%, #202c33 0, transparent 40%);
      background-color: #0b141a;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .msg {
      max-width: 70%;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.4;
      position: relative;
      white-space: pre-wrap;
    }
    .msg.me {
      align-self: flex-start;
      background-color: #202c33;
    }
    .msg.bot {
      align-self: flex-end;
      background-color: #005c4b;
    }
    .msg-time {
      font-size: 10px;
      color: #8696a0;
      margin-top: 2px;
      text-align: left;
    }

    .chat-input {
      padding: 8px 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      background-color: #202c33;
      border-top: 1px solid #202c33;
    }
    .chat-input input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 16px;
      border: none;
      outline: none;
      background-color: #111b21;
      color: #e9edef;
      font-size: 13px;
    }
    .chat-input button {
      padding: 8px 14px;
      border-radius: 16px;
      border: none;
      background-color: #128c7e;
      color: #e9edef;
      font-size: 13px;
      cursor: pointer;
    }
    .chat-input button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .empty-chat {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #8696a0;
      font-size: 14px;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background-color: #111b21;
      border-radius: 12px;
      padding: 16px;
      width: 300px;
      border: 1px solid #202c33;
    }
    .modal h3 {
      font-size: 14px;
      margin-bottom: 10px;
    }
    .modal label {
      font-size: 12px;
      color: #8696a0;
      display: block;
      margin-top: 8px;
    }
    .modal input {
      width: 100%;
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #202c33;
      background: #0b141a;
      color: #e9edef;
      font-size: 12px;
    }
    .modal-actions {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }
    .modal-actions button {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
    .btn-secondary {
      background: transparent;
      color: #e9edef;
      border: 1px solid #202c33;
    }
    .btn-primary {
      background: #128c7e;
      color: #e9edef;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="bot-info">
          <div class="bot-avatar" id="botAvatarBox">
            <span id="botAvatarFallback">SB</span>
          </div>
          <div>
            <div class="bot-name" id="botNameBox">Smart Bot</div>
            <div style="font-size:11px;color:#8696a0;">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… â€“ ÙˆØ§ØªØ³Ø§Ø¨</div>
          </div>
        </div>
        <button class="owner-btn" id="ownerBtn">Ø§Ù„Ù…Ø§Ù„Ùƒ</button>
      </div>
      <div class="contacts-list" id="contactsList"></div>
    </div>
    <div class="chat" id="chatArea">
      <div class="empty-chat">
        Ø§Ø®ØªØ± Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ğŸ‘ˆ
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="settingsModal">
    <div class="modal">
      <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª</h3>
      <label>Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª</label>
      <input type="text" id="inputBotName" />
      <label>Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¨ÙˆØª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input type="text" id="inputBotAvatar" placeholder="https://..." />
      <label>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø§Ù„Ùƒ</label>
      <input type="password" id="inputOwnerPassword" placeholder="Mmaa3551" />
      <div class="modal-actions">
        <button class="btn-secondary" id="btnCancelSettings">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn-primary" id="btnSaveSettings">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <script>
    const contactsListEl = document.getElementById("contactsList");
    const chatAreaEl = document.getElementById("chatArea");
    const botNameBox = document.getElementById("botNameBox");
    const botAvatarBox = document.getElementById("botAvatarBox");

    const settingsModal = document.getElementById("settingsModal");
    const ownerBtn = document.getElementById("ownerBtn");
    const inputBotName = document.getElementById("inputBotName");
    const inputBotAvatar = document.getElementById("inputBotAvatar");
    const inputOwnerPassword = document.getElementById("inputOwnerPassword");
    const btnCancelSettings = document.getElementById("btnCancelSettings");
    const btnSaveSettings = document.getElementById("btnSaveSettings");

    let contacts = [];
    let activeContactId = null;

    function apiGet(path) {
      return fetch(path).then((r) => r.json());
    }

    function apiPost(path, body) {
      return fetch(path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      }).then((r) => r.json());
    }

    function apiDelete(path) {
      return fetch(path, { method: "DELETE" }).then((r) => r.json());
    }

    function formatTime(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      return d.toLocaleTimeString("ar-SA", {
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function renderBotHeader(settings) {
      const name = settings.bot_name || "Smart Bot";
      const avatar = settings.bot_avatar || "";
      botNameBox.textContent = name;

      if (avatar) {
        botAvatarBox.innerHTML = '<img src="' + avatar + '" alt="avatar" />';
      } else {
        const letters = name
          .split(" ")
          .map((w) => w[0])
          .join("")
          .slice(0, 2)
          .toUpperCase();
        botAvatarBox.textContent = letters || "SB";
      }
    }

    function renderContacts() {
      contactsListEl.innerHTML = "";
      contacts.forEach((c) => {
        const item = document.createElement("div");
        item.className = "contact-item" + (c.id === activeContactId ? " active" : "");
        item.dataset.id = c.id;

        const top = document.createElement("div");
        top.className = "contact-top";

        const nameEl = document.createElement("div");
        nameEl.className = "contact-name";
        nameEl.textContent = c.display_name || c.wa_id;

        const rightTop = document.createElement("div");
        rightTop.style.display = "flex";
        rightTop.style.alignItems = "center";
        rightTop.style.gap = "6px";

        if (c.bot_paused) {
          const badge = document.createElement("span");
          badge.className = "badge-paused";
          badge.textContent = "Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡";
          rightTop.appendChild(badge);
        }

        const timeEl = document.createElement("div");
        timeEl.style.fontSize = "11px";
        timeEl.style.color = "#8696a0";
        timeEl.textContent = c.last_timestamp ? formatTime(c.last_timestamp) : "";
        rightTop.appendChild(timeEl);

        top.appendChild(nameEl);
        top.appendChild(rightTop);

        const lastEl = document.createElement("div");
        lastEl.className = "contact-last";
        lastEl.textContent = c.last_message || "";

        item.appendChild(top);
        item.appendChild(lastEl);

        item.addEventListener("click", () => {
          activeContactId = c.id;
          renderContacts();
          openChat(c.id, c.display_name || c.wa_id, c.bot_paused);
        });

        contactsListEl.appendChild(item);
      });
    }

    function renderEmptyChat() {
      chatAreaEl.innerHTML = "";
      const div = document.createElement("div");
      div.className = "empty-chat";
      div.textContent = "Ø§Ø®ØªØ± Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ğŸ‘ˆ";
      chatAreaEl.appendChild(div);
    }

    async function openChat(contactId, title, paused) {
      const msgs = await apiGet("/api/contacts/" + contactId + "/messages");

      chatAreaEl.innerHTML = "";

      const header = document.createElement("div");
      header.className = "chat-header";

      const left = document.createElement("div");
      const titleEl = document.createElement("div");
      titleEl.className = "chat-title";
      titleEl.textContent = title;

      const sub = document.createElement("div");
      sub.className = "chat-sub";
      sub.textContent = paused
        ? "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§Ù„Ø¨ÙˆØª Ù…ØªÙˆÙ‚Ù)"
        : "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø¨ÙˆØª";

      left.appendChild(titleEl);
      left.appendChild(sub);

      const actions = document.createElement("div");
      actions.className = "chat-header-actions";

      const toggleBtn = document.createElement("button");
      toggleBtn.textContent = paused ? "ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª" : "Ø¥ÙŠÙ‚Ø§Ù (Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡)";
      toggleBtn.addEventListener("click", async () => {
        const newPaused = !paused;
        await apiPost("/api/contacts/" + contactId + "/bot-toggle", {
          paused: newPaused
        });
        loadContacts();
        openChat(contactId, title, newPaused);
      });

      const delBtn = document.createElement("button");
      delBtn.textContent = "Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©";
      delBtn.addEventListener("click", async () => {
        if (!confirm("Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙƒØ§Ù…Ù„Ø©ØŸ")) return;
        await apiDelete("/api/contacts/" + contactId);
        activeContactId = null;
        loadContacts();
        renderEmptyChat();
      });

      actions.appendChild(toggleBtn);
      actions.appendChild(delBtn);

      header.appendChild(left);
      header.appendChild(actions);

      const msgsBox = document.createElement("div");
      msgsBox.className = "chat-messages";

      msgs.forEach((m) => {
        const item = document.createElement("div");
        item.className = "msg" + (m.from_me ? " bot" : " me");
        const bodyEl = document.createElement("div");
        bodyEl.textContent = m.body;
        const timeEl = document.createElement("div");
        timeEl.className = "msg-time";
        timeEl.textContent = formatTime(m.timestamp);
        item.appendChild(bodyEl);
        item.appendChild(timeEl);
        msgsBox.appendChild(item);
      });

      const inputBar = document.createElement("div");
      inputBar.className = "chat-input";

      const input = document.createElement("input");
      input.placeholder = "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„...";

      const sendBtn = document.createElement("button");
      sendBtn.textContent = "Ø¥Ø±Ø³Ø§Ù„";

      function sendNow() {
        const txt = input.value.trim();
        if (!txt) return;
        sendBtn.disabled = true;
        apiPost("/api/contacts/" + contactId + "/send", { body: txt })
          .then(() => {
            input.value = "";
            return apiGet("/api/contacts/" + contactId + "/messages");
          })
          .then((msgs2) => {
            msgsBox.innerHTML = "";
            msgs2.forEach((m) => {
              const item = document.createElement("div");
              item.className = "msg" + (m.from_me ? " bot" : " me");
              const bodyEl = document.createElement("div");
              bodyEl.textContent = m.body;
              const timeEl = document.createElement("div");
              timeEl.className = "msg-time";
              timeEl.textContent = formatTime(m.timestamp);
              item.appendChild(bodyEl);
              item.appendChild(timeEl);
              msgsBox.appendChild(item);
            });
            msgsBox.scrollTop = msgsBox.scrollHeight;
          })
          .finally(() => {
            sendBtn.disabled = false;
          });
      }

      sendBtn.addEventListener("click", sendNow);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendNow();
      });

      inputBar.appendChild(input);
      inputBar.appendChild(sendBtn);

      chatAreaEl.appendChild(header);
      chatAreaEl.appendChild(msgsBox);
      chatAreaEl.appendChild(inputBar);

      msgsBox.scrollTop = msgsBox.scrollHeight;
    }

    async function loadSettings() {
      const s = await apiGet("/api/settings");
      renderBotHeader(s);
      inputBotName.value = s.bot_name || "Smart Bot";
      inputBotAvatar.value = s.bot_avatar || "";
    }

    async function loadContacts() {
      contacts = await apiGet("/api/contacts");
      renderContacts();
      if (activeContactId) {
        const c = contacts.find((x) => x.id === activeContactId);
        if (c) {
          openChat(c.id, c.display_name || c.wa_id, c.bot_paused);
        } else {
          activeContactId = null;
          renderEmptyChat();
        }
      }
    }

    ownerBtn.addEventListener("click", () => {
      settingsModal.style.display = "flex";
    });
    btnCancelSettings.addEventListener("click", () => {
      settingsModal.style.display = "none";
    });
    btnSaveSettings.addEventListener("click", async () => {
      const name = inputBotName.value.trim();
      const avatar = inputBotAvatar.value.trim();
      const pwd = inputOwnerPassword.value.trim();
      const res = await apiPost("/api/settings", {
        bot_name: name,
        bot_avatar: avatar,
        owner_password: pwd
      });
      if (res && res.success) {
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        settingsModal.style.display = "none";
        inputOwnerPassword.value = "";
        loadSettings();
      } else {
        alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ£ÙƒØ¯ Ù…Ù† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø§Ù„Ùƒ.");
      }
    });

    loadSettings();
    loadContacts();
    setInterval(loadContacts, 8000);
  </script>
</body>
</html>
